# =============================================================================
# Helpdesk WhatsApp + GLPI - PRODUÇÃO
# Apenas os serviços da aplicação (usa PostgreSQL, Redis, RabbitMQ externos)
# =============================================================================

services:
  # ============================================================================
  # Backend NestJS
  # ============================================================================
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: helpdesk_backend
    restart: unless-stopped
    ports:
      - "4000:3000"
    env_file:
      - .env
    environment:
      NODE_ENV: production
    volumes:
      - ./backend/logs:/app/logs
    networks:
      - helpdesk_network
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:3000/api/bot/status"]
      interval: 30s
      timeout: 10s
      retries: 3

  # ============================================================================
  # Frontend Next.js
  # ============================================================================
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-https://bk.shautomacao.com.br}
    container_name: helpdesk_frontend
    restart: unless-stopped
    ports:
      - "4001:3000"
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-https://bk.shautomacao.com.br}
    networks:
      - helpdesk_network
    depends_on:
      backend:
        condition: service_healthy

  # ============================================================================
  # Bot WhatsApp
  # ============================================================================
  bot:
    build:
      context: ./bot
      dockerfile: Dockerfile
    container_name: helpdesk_bot
    restart: unless-stopped
    env_file:
      - .env
    environment:
      NODE_ENV: production
    volumes:
      - ./bot/sessions:/app/sessions
      - ./bot/logs:/app/logs
    networks:
      - helpdesk_network
    depends_on:
      backend:
        condition: service_healthy

# ==============================================================================
# Networks
# ==============================================================================
networks:
  helpdesk_network:
    name: helpdesk_network
    driver: bridge
