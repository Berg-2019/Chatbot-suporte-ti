// ===========================================================================
// Prisma Schema - Helpdesk + GLPI Integration
// ===========================================================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===========================================================================
// Users / Technicians
// ===========================================================================

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  password  String
  name      String
  role      Role     @default(AGENT)
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Integração GLPI
  glpiUserId    Int?              // ID do usuário no GLPI
  glpiGroupId   Int?              // ID do grupo no GLPI (N1, N2, N3)
  
  // Nível técnico
  technicianLevel TechnicianLevel @default(N1)
  
  // Alertas
  phoneNumber   String?           // WhatsApp para receber alertas
  receiveAlerts Boolean           @default(true)

  tickets   Ticket[]
  messages  Message[]
  alerts    TechnicianAlert[]

  @@map("users")
}

enum Role {
  ADMIN
  AGENT
}

enum TechnicianLevel {
  N1   // Primeiro nível - atendimento básico
  N2   // Segundo nível - suporte intermediário
  N3   // Terceiro nível - especialista
}

// ===========================================================================
// Tickets
// ===========================================================================

model Ticket {
  id          String       @id @default(uuid())
  glpiId      Int?         @unique    // ID do ticket no GLPI
  title       String
  description String
  status      TicketStatus @default(NEW)
  priority    Priority     @default(NORMAL)
  phoneNumber String                  // Telefone do cliente
  customerName String?                // Nome do cliente (coletado pelo bot)
  sector      String?                 // Setor do cliente
  category    String?                 // Categoria/tipo do problema

  // Campos de fechamento
  solution     String?                // Texto da solução aplicada
  solutionType String?                // Categoria da solução (Hardware, Software, etc)
  timeWorked   Int?                   // Tempo trabalhado em minutos

  assignedToId String?
  assignedTo   User?   @relation(fields: [assignedToId], references: [id])

  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  closedAt    DateTime?

  messages    Message[]
  partUsages  PartUsage[]

  @@map("tickets")
  @@index([phoneNumber])
  @@index([status])
  @@index([glpiId])
}

enum TicketStatus {
  NEW            // Novo - aguardando atendimento
  ASSIGNED       // Atribuído a um técnico
  IN_PROGRESS    // Em atendimento
  WAITING_CLIENT // Aguardando resposta do cliente
  RESOLVED       // Resolvido
  CLOSED         // Fechado
}

enum Priority {
  LOW
  NORMAL
  HIGH
  URGENT
}

// ===========================================================================
// Messages
// ===========================================================================

model Message {
  id        String      @id @default(uuid())
  ticketId  String
  ticket    Ticket      @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  content   String
  type      MessageType @default(TEXT)
  direction Direction

  senderId  String?
  sender    User?       @relation(fields: [senderId], references: [id])

  waMessageId String?   // ID da mensagem no WhatsApp

  createdAt DateTime    @default(now())

  @@map("messages")
  @@index([ticketId])
}

enum MessageType {
  TEXT
  IMAGE
  AUDIO
  DOCUMENT
}

enum Direction {
  INCOMING  // Cliente → Sistema
  OUTGOING  // Sistema → Cliente
}

// ===========================================================================
// Bot Session State (backup do Redis)
// ===========================================================================

model BotSession {
  id          String   @id @default(uuid())
  phoneNumber String   @unique
  state       String   // Estado atual da conversa (JSON)
  data        String?  // Dados coletados (JSON)
  expiresAt   DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("bot_sessions")
  @@index([phoneNumber])
}

// ===========================================================================
// Queues / Skills
// ===========================================================================

model Queue {
  id          String   @id @default(uuid())
  name        String   @unique
  description String?
  skills      String   // JSON array de skills
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())

  @@map("queues")
}

// ===========================================================================
// Parts Inventory - Controle de Peças
// ===========================================================================

model Part {
  id          String   @id @default(uuid())
  name        String
  code        String   @unique  // SKU/Código interno
  description String?
  quantity    Int      @default(0)
  minQuantity Int      @default(5)  // Alerta de estoque baixo
  unitCost    Decimal  @db.Decimal(10,2)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  usages      PartUsage[]

  @@map("parts")
}

// ===========================================================================
// Part Usage - Peças usadas nos tickets
// ===========================================================================

model PartUsage {
  id        String   @id @default(uuid())
  ticketId  String
  ticket    Ticket   @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  partId    String?
  part      Part?    @relation(fields: [partId], references: [id])
  partName  String   // Nome da peça (útil para peças compradas avulso)
  quantity  Int
  unitCost  Decimal  @db.Decimal(10,2)
  purchased Boolean  @default(false)  // Se foi comprada para este chamado
  createdAt DateTime @default(now())

  @@map("part_usages")
  @@index([ticketId])
}

// ===========================================================================
// FAQ - Base de Conhecimento
// ===========================================================================

model Faq {
  id          String   @id @default(uuid())
  question    String
  answer      String   @db.Text
  keywords    String   // Palavras-chave separadas por vírgula
  category    String?
  views       Int      @default(0)
  helpful     Int      @default(0)
  active      Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("faqs")
  @@index([keywords])
}

// ===========================================================================
// Technician Alerts - Alertas para técnicos
// ===========================================================================

model TechnicianAlert {
  id          String     @id @default(uuid())
  
  userId      String
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  ticketId    String?    // ID local do ticket
  glpiId      Int?       // ID do ticket no GLPI
  
  type        AlertType
  message     String
  
  sentViaWa   Boolean    @default(false)  // Enviado via WhatsApp
  sentViaPush Boolean    @default(false)  // Enviado via Socket.IO
  readAt      DateTime?
  
  createdAt   DateTime   @default(now())

  @@map("technician_alerts")
  @@index([userId])
  @@index([ticketId])
}

enum AlertType {
  NEW_TICKET    // Novo ticket atribuído
  ESCALATED     // Ticket escalonado do nível anterior
  SLA_WARNING   // 75% do tempo SLA atingido
  SLA_BREACH    // SLA estourado
  NEW_MESSAGE   // Nova mensagem do cliente
  TRANSFERRED   // Ticket transferido para você
}
